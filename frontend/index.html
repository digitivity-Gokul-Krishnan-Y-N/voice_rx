<!DOCTYPE html>
<html>
<head>
  <title>Voice RX</title>
  <style>
    body {
      font-family: Arial;
      display: flex;
      height: 100vh;
      margin: 0;
    }
    .left, .right {
      width: 50%;
      padding: 20px;
      box-sizing: border-box;
    }
    textarea, input, select {
      width: 100%;
      margin-bottom: 10px;
      padding: 8px;
      box-sizing: border-box;
    }
    button {
      padding: 10px 20px;
      margin-right: 10px;
      cursor: pointer;
    }
    table {
      border-collapse: collapse;
      width: 100%;
    }
    th, td {
      padding: 6px;
      text-align: center;
    }
    .timing-row {
      display: flex;
      justify-content: center;
      gap: 10px;
    }
    .timing-row label {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 13px;
    }
  </style>
</head>
<body>

<div class="left">
  <h2>üéôÔ∏è Record Consultation</h2>
  <button onclick="startRecording()">Start</button>
  <button onclick="stopRecording()">Stop</button>
  <p id="status">Idle</p>
</div>

<div class="right">
  <h2>üßæ Prescription</h2>

  <input id="patient_name" placeholder="Patient Name">
  <textarea id="complaints" placeholder="Complaints"></textarea>
  <textarea id="diagnosis" placeholder="Diagnosis"></textarea>

  <h3>Medicines</h3>
  <table border="1" id="medTable">
    <thead>
      <tr>
        <th>Name</th>
        <th>Dose</th>
        <th>Timing (M-A-E-N)</th>
        <th>Duration</th>
        <th>Food</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <textarea id="tests" placeholder="Tests"></textarea>
  <textarea id="advice" placeholder="Advice"></textarea>

  <button onclick="downloadPDF()">Download PDF</button>
</div>

<script>
let mediaRecorder;
let audioChunks = [];
let audioStream;
let isRecording = false;

// ================= RECORDING =================

async function startRecording() {
  if (isRecording) return;

  audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
  mediaRecorder = new MediaRecorder(audioStream, { mimeType: "audio/webm" });
  audioChunks = [];
  isRecording = true;

  document.getElementById("status").innerText = "üî¥ Recording...";

  mediaRecorder.ondataavailable = e => {
    if (e.data.size > 0) audioChunks.push(e.data);
  };

  mediaRecorder.onstop = async () => {
    document.getElementById("status").innerText = "‚èπÔ∏è Processing...";

    const blob = new Blob(audioChunks, { type: "audio/webm" });
    const formData = new FormData();
    formData.append("file", blob, "audio.webm");

    try {
      const res = await fetch("/process-audio", {
        method: "POST",
        body: formData
      });

      if (!res.ok) {
        throw new Error(`HTTP error! status: ${res.status}`);
      }

      const data = await res.json();
      if (data.error) {
        document.getElementById("status").innerText = `‚ùå Error: ${data.error}`;
        return;
      }
      const rx = data.prescription || {};

      document.getElementById("patient_name").value = rx.patient_name || "";      document.getElementById(\"complaints\").value = (rx.complaints || []).join(\", \");      document.getElementById("diagnosis").value = (rx.diagnosis || []).join(", ");
      document.getElementById("tests").value = (rx.tests || []).join(", ");
      document.getElementById("advice").value = (rx.advice || []).join(", ");

    const tbody = document.querySelector("#medTable tbody");
    tbody.innerHTML = "";

    (rx.medicines || []).forEach(med => {
      const row = document.createElement("tr");

      row.innerHTML = `
        <td><input name="name" value="${med.name || ""}"></td>
        <td><input name="dose" value="${med.dose || ""}"></td>

        <td>
          <div class="timing-row">
            <label><input type="checkbox" data-slot="0"> M</label>
            <label><input type="checkbox" data-slot="1"> A</label>
            <label><input type="checkbox" data-slot="2"> E</label>
            <label><input type="checkbox" data-slot="3"> N</label>
          </div>
        </td>

        <td><input name="duration" value="${med.duration || ""}"></td>

        <td>
          <select name="food">
            <option>After food</option>
            <option>Before food</option>
            <option>With food</option>
            <option>As needed</option>
          </select>
        </td>
      `;

      // Timing prefill
      if (med.timing) {
        med.timing.split("-").forEach((v, i) => {
          if (v === "1") {
            row.querySelector(`input[data-slot="${i}"]`).checked = true;
          }
        });
      }

      if (med.instruction) {
        row.querySelector("select").value = med.instruction;
      }

      tbody.appendChild(row);
    });

    document.getElementById("status").innerText = "‚úÖ Done";
    } catch (error) {
      document.getElementById("status").innerText = `‚ùå Error: ${error.message}`;
      console.error(\"Error:\", error);
    }
  };

  mediaRecorder.start(1000); // force chunks
}

function stopRecording() {
  if (!isRecording) return;
  isRecording = false;
  mediaRecorder.stop();
  audioStream.getTracks().forEach(t => t.stop());
}

// ================= PDF =================

async function downloadPDF() {

  const medicines = [];

  document.querySelectorAll("#medTable tbody tr").forEach(row => {

    const name = row.querySelector("input[name='name']").value.trim();
    const dose = row.querySelector("input[name='dose']").value.trim();
    const duration = row.querySelector("input[name='duration']").value.trim();
    const food = row.querySelector("select[name='food']").value;

    const timing = Array.from(
      row.querySelectorAll("input[type='checkbox']")
    ).map(cb => cb.checked ? "1" : "0").join("-");

    if (name) {
      medicines.push({
        name,
        dose,
        timing,
        duration,
        instruction: food
      });
    }
  });

  const payload = {
    patient_name: document.getElementById("patient_name").value,    complaints: document.getElementById(\"complaints\").value,    diagnosis: document.getElementById("diagnosis").value,
    medicines,
    tests: document.getElementById("tests").value,
    advice: document.getElementById("advice").value
  };

  const res = await fetch(\"/generate-pdf\", {
    method: \"POST\",
    headers: { \"Content-Type\": \"application/json\" },
    body: JSON.stringify(payload)
  });

  if (!res.ok) {
    alert(\"Error generating PDF: \" + res.statusText);
    return;
  }

  const blob = await res.blob();
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "prescription.pdf";
  a.click();
  URL.revokeObjectURL(url);
}
</script>

</body>
</html>